name: Replace MarkItUp in includes

on:
  workflow_dispatch:

jobs:
  replace_markitup:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'

      - name: Find and Replace in .inc files
        run: |
          find lib -type f -name '*.inc' -print0 | while IFS= read -r -d $'\0' file; do
            if grep -q "markitup::" "$file"; then
                echo "Processing: $file"
                
                # Ersetze das MarkItUp
                sed -i 's/markitup::MarkItUp::/MarkItUp::/g' "$file"

                # Überprüfe ob bereits <?php am Anfang steht
                if ! grep -q "^<\?php" "$file"; then
                    echo "Adding '<?php' at beginning of $file"
                    # Füge <?php und den use-statement hinzu
                    sed -i '1s/^/<?php\nuse FriendsOfRedaxo\\MarkItUp\\MarkItUp;\n/' "$file"
                else
                    echo "<?php already found at beginning of $file"
                fi

            else
                echo "Skipping $file, no markitup:: found"
            fi
          done
      
      - name: Configure Git
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'actions@github.com'

      - name: Commit and Push Changes
        run: |
          git checkout -b refactor/markitup-replace
          git add .
          git commit -m "Refactor: Replace markitup:: and add use statement"
          git push origin refactor/markitup-replace
          echo "Pushed changes to branch refactor/markitup-replace"


      - name: Create Pull Request
        uses: actions/github-script@v6
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            console.log('Attempting to create pull request...')
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Refactor: Replace markitup:: and add use statement',
              head: 'refactor/markitup-replace',
              base: 'main',
              body: 'This pull request replaces `markitup::MarkItUp::` with `MarkItUp::` in all `.inc` files under `lib/` and adds `<?php` and `use FriendsOfRedaxo\\MarkItUp\\MarkItUp;` at the beginning if not present.',
            });
            console.log(`Pull request created: ${pr.html_url}`);
